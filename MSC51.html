<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>MSC51</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Consolas"!important;
    }
    
    html,
    body {
      background: #282c34;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    
    .app {
      display: flex;
      width: 100%;
      height: 100%;
      min-width: 600px;
      margin: 10px auto;
    }
    
    .data-wrapper {
      flex: 233px 0 0;
      height: 100%;
      background: #21252b;
      color: #bba;
      font-size: 18px;
    }
    
    .data-wrapper h3 {
      font-size: 15px;
      font-weight: 500;
      color: #81858b;
      text-align: center;
      line-height: 30px;
      border-bottom: 1px solid #31353b;
      margin-top: 10px;
    }
    
    .data-wrapper .list {
      line-height: 20px;
    }
    
    .data-wrapper .list .item {
      display: flex;
    }
    
    .data-wrapper .list .item .name {
      flex: 1;
      height: 23px;
      text-align: right;
      padding-right: 25px;
    }
    
    .data-wrapper .list .item .data {
      flex: 1;
      height: 23px;
      text-align: left;
    }
    
    .editor-wrapper {
      flex: 1;
      height: 100%;
      color: #ff0;
    }
    
    .editor-container {
      position: relative;
      width: 100%;
      height: 100%;
      cursor: text;
    }
    
    .top-contorl {
      position: absolute;
      right: 20px;
    }
    
    .top-contorl button {
      color: aliceblue;
      background: transparent;
      border: none;
      font-size: 18px;
    }
    
    textarea {
      position: absolute;
      top: 20px;
      left: 20px;
      width: 100%;
      height: 100%;
      background: transparent;
      border: none;
      color: aliceblue;
      font-family: "Consolas"!important;
      font-size: 30px;
    }
    
    textarea:focus {
      border: none;
      box-shadow: none;
      outline: none
    }
    
    @keyframes flash {
      from {
        color: #bba;
        text-shadow: 0;
      }
      to {
        color: #FFF;
        text-shadow: 0 0 1px #DDD, 0px 0px 2px #FFF, 0 0 10px #FFF;
      }
    }
    
    .luminous {
      animation: flash 3s infinite alternate;
    }
  </style>

  <style>

  </style>
</head>

<body>
  <div class="app">
    <div class="data-wrapper">
      <div class="work_register-group">
        <h3>工作寄存器组</h3>
        <ul class="list">
          <li class="item">
            <p class="name">R0:</p>
            <p class="data">0</p>
          </li>
          <li class="item">
            <p class="name">R1:</p>
            <p class="data">0</p>
          </li>
          <li class="item">
            <p class="name">R2:</p>
            <p class="data">0</p>
          </li>
          <li class="item">
            <p class="name">R3:</p>
            <p class="data">0</p>
          </li>
          <li class="item">
            <p class="name">R4:</p>
            <p class="data">0</p>
          </li>
          <li class="item">
            <p class="name">R5:</p>
            <p class="data">0</p>
          </li>
          <li class="item">
            <p class="name">R6:</p>
            <p class="data">0</p>
          </li>
          <li class="item">
            <p class="name">R7:</p>
            <p class="data">0</p>
          </li>
        </ul>
      </div>
      <div class="SRF">
        <h3>特殊功能寄存器</h3>
        <ul class="list">
          <li class="item">
            <p class="name">P0:</p>
            <p class="data">0</p>
          </li>
          <li class="item">
            <p class="name">SP:</p>
            <p class="data">0</p>
          </li>
          <li class="item">
            <p class="name">DPL:</p>
            <p class="data">0</p>
          </li>
          <li class="item">
            <p class="name">DPH:</p>
            <p class="data">0</p>
          </li>
          <li class="item">
            <p class="name">PCON:</p>
            <p class="data">0</p>
          </li>
          <li class="item">
            <p class="name">TCON:</p>
            <p class="data">0</p>
          </li>
          <li class="item">
            <p class="name">TL0:</p>
            <p class="data">0</p>
          </li>
          <li class="item">
            <p class="name">TL1:</p>
            <p class="data">0</p>
          </li>
          <li class="item">
            <p class="name">TH0:</p>
            <p class="data">0</p>
          </li>
          <li class="item">
            <p class="name">TH1:</p>
            <p class="data">0</p>
          </li>
          <li class="item">
            <p class="name">P1:</p>
            <p class="data">0</p>
          </li>
          <li class="item">
            <p class="name">SCON:</p>
            <p class="data">0</p>
          </li>
          <li class="item">
            <p class="name">PSW:</p>
            <p class="data">0</p>
          </li>
          <li class="item">
            <p class="name">A*:</p>
            <p class="data">0</p>
          </li>
          <li class="item">
            <p class="name">B*:</p>
            <p class="data">0</p>
          </li>
        </ul>
      </div>
      <div class="RAM">
        <h3>RAM</h3>
        <ul></ul>
      </div>
    </div>
    <div class="editor-wrapper">
      <div class="editor-container">
        <div class="top-contorl">
          <button onclick="run()"> 运行 </button>
        </div>
        <textarea wrap="off" placeholder="QWQ" autocorrect="off" autocapitalize="off" autocomplete="off" spellcheck="false" aria-lable="现在无法访问编辑器。按 Alt+F1  显示选项。" role="textbox" aria-multiline="true" aria-haspopup="false" aria-autocomplete="both"></textarea>
        <!-- <input data-mprt="6" class="inputarea" wrap="off" autocorrect="off" autocapitalize="off" autocomplete="off" spellcheck="false" aria-lable="现在无法访问编辑器。按 Alt+F1  显示选项。" role="textbox" aria-multiline="true" aria-haspopup="false" aria-autocomplete="both"></input> -->
      </div>
    </div>
  </div>

  <script>
    DEFAULT_CODE = `MOV A,#1H
MOV B,#2H
CJNE A,B,C
MOV R0,#1H
C: MOV R0,#1H
`
    const FREQUENC = 150;
    const DEV = true;
    // const DEV = false;
    const log = DEV ? console.log : fun = () => {};

    function setData(name, data) {
      let element = document.querySelector('[data-name="' + name + '"]');
      if (!element) {
        return Error('element not found')
      };
      element.parentElement.classList.add('luminous');
      setTimeout(() => {
        element.parentElement.classList.remove('luminous');
      }, 6000)
      element.innerHTML = data || 0;
    }

    class History {
      constructor() {
        localStorage.code = [];
        this.code = localStorage.getItem('code');
      }
      pushCode(item) {
        this.code.push(item);
      }

      getCode() {
        return this.code[this.code.length - 1]
      }

    }
  </script>


  <script>
    /*
     * 
     */
    class ByteUnit {
      constructor(address, data) {
        this._address = address;
        this._data = data;
      }

      set address(val) {
        if (/\d+H/.test) {
          val = parseInt(val, 16);
        }
        if (val > 0xFF) {
          this._address = val % 0XFF;
          return true;
        } else if (val < 0x0) {
          this._address = 0;
        }
        this._address = val;
      }

      get address() {
        return '0'.repeat(2 - this._address.toString(16).length) + this._address.toString(16);
      }

      set data(val) {
        if (/\d+H/.test(val)) {
          val = parseInt(val, 16);
        }
        if (val > 0xFF) {
          this._data = val % 0XFF;
          return true;
        } else if (val < 0x0) {
          this._data = 0;
        }
        this._data = val;
        if (this.name) {
          setData(this.name, val.toString(16));
        }
      }

      get data() {
        console.assert(2 - this._data.toString(16).length >= 0, 2 - this._data.toString(16).length, this._data, this._data.toString(16));
        return '0'.repeat(2 - this._data.toString(16).length) + this._data.toString(16);
      }


      getBit(n) {
        if (n >= 0 && n < 8) {
          return (parseInt(this.data, 16) >> n & 1) != 'undefined' ? (parseInt(this.data, 16) >> n & 1) : 0;
        }
      }

      setBit(n, b) {
        if (n >= 0 && n < 8) {
          if (b === 0) {
            this._data = parseInt(this._data, 16) & ~Math.pow(2, n);
          } else {
            this._data = parseInt(this._data, 16) ^ Math.pow(2, n);
          }
        }
        setData(this.name, this.data.toString(16));
      }
    }

    class ByteUnitX extends ByteUnit {
      constructor(address, data) {
        super(address, data);
      }

      set address(val) {
        if (val > 0xFFFF) {
          this._address = `${val % 0XFFFF}`.toString(16);
          return true;
        } else if (val < 0x0) {
          this._address = 0;
        }
        this._address = val.toString(16);
      }

      get address() {
        return '0'.repeat(4 - this._address.length) + a;
      }
    }

    class Register extends ByteUnit {
      constructor(address, data, name) {
        super(address, data);
        this.name = name;
      }
    }

    class SFR extends ByteUnit {
      constructor(address, data, name) {
        super(address, data);
        this.name = name;
      }
    }

    class PSW extends SFR {
      constructor(address, data, name) {
        super(address, data, name);
      }

      get P() {
        return this.getBit(0)
      }
      get OV() {
        return this.getBit(2)
      }
      get RS0() {
        return this.getBit(3)
      }
      get RS1() {
        return this.getBit(4)
      }
      get F0() {
        return this.getBit(5)
      }
      get AC() {
        return this.getBit(6)
      }
      get CY() {
        return this.getBit(7)
      }

      set P(value) {
        this.setBit(0, value > 0 ? 1 : 0)
      }
      set OV(value) {
        this.setBit(2, value > 0 ? 1 : 0)
      }
      set RS0(value) {
        this.setBit(3, value > 0 ? 1 : 0)
      }
      set RS1(value) {
        this.setBit(4, value > 0 ? 1 : 0)
      }
      set F0(value) {
        this.setBit(5, value > 0 ? 1 : 0)
      }
      set AC(value) {
        this.setBit(6, value > 0 ? 1 : 0)
      }
      set CY(value) {
        this.setBit(7, value > 0 ? 1 : 0)
      }
    }

    /** 指令 */
    class Instructs {
      constructor() {
        let i = 0;
        //label
        if (/\:$/.test(arguments[i])) {
          this.lable = arguments[i];
          i++;
        }
        //操作符
        this.oc = arguments[i++];

        this.destination = arguments[i++];
        this.source = arguments[i++];
        if (!/^;/.test(arguments[i])) {
          this.rel = arguments[i++]
        }
        if (/^;/.test(arguments[i])) {
          this.annotation = arguments[i++]
        }
        this.id = Instructs.count++;
      }
    }
    Instructs.count = 0;



    class Program {
      constructor() {
        this.instructs = []; //存放指令（应该是ROM，但是.....不想写了，ROM写在正式版里）
        this.RAML128 = []; //可通过直接寻址和间接寻址访问
        this.RAMH128 = []; //只通过直接寻址访问
        this.RAMX = []; //外部RAM
        this.PC = 0; //PC指针
        this.OC = {}; //指令集
        this.RAM = {} //暂留 
        this.lables = []; //保存长跳转的位置表
        this.workingRegistersGroup = [];
        this._initRAML128();
        this._initSFR();
        this._initOC();
        this._initROMX();
      }

      get RSG() {
        return this.getSFR('PSW').RS1 * 2 + this.getSFR('PSW').RS0 * 1
      }

      getSFR(name) {
        return this.RAMH128.find(i => i.name === name) || this.RAMH128[0]
      }

      _getValueToInt(s) {
        if (typeof s.data === 'undefined') {
          return parseInt(s);
        } else {
          return parseInt(s.data);
        }
      }

      _initOC() {
        let self = this;
        this.OC = {
          ['ORG'](d) {

          },
          ['MOV'](d, s) { //sucess
            if (typeof self.getByteUnit(s).data === 'undefined') {
              self.getByteUnit(d).data = self.getByteUnit(s);
            } else {
              self.getByteUnit(d).data = self.getByteUnit(s).data;
            }
          },
          ['MOVC'](d, s) {

          },
          ['PUSH'](direct) {
            self.getSFR('SP').data += 1;
            self.getSFR('SP').data += direct;
          },
          ['POP'](direct) {
            self.getSFR('SP').data -= direct;
            self.getSFR('SP').data -= 1;
          },
          ['XCH'](d, s) {
            [self.getByteUnit(d).data, self.getByteUnit(s).data] = [self.getByteUnit(s).dat, self.getByteUnit(d).data];
          },
          //TODO :有的指令只能操作A
          ['XCHD'](d, s) {
            let A = self.getSFR('A*');
            let byteUnit = self.getByteUnit(s);
            let H4 = (0x0F & parseInt(byteUnit.data, 16)) / 0x0F;
            let L4 = 0xF0 & parseInt(byteUnit.data, 16);
            byteUnit.data = L4 * 0xF + H4 * 0x1
          },
          ['ADD'](d, s) {
            let A = self.getSFR('A*');
            var a = parseInt(A.data, 16);
            var b = 0;
            if (typeof self.getByteUnit(s) === 'number') {
              b = parseInt(self.getByteUnit(s));
            } else {
              b = parseInt(self.getByteUnit(s).data);
            }
            A.data = a + b;
          },
          ['ADDC'](d, s) {
            if (d === self.getSFR('A*')) {
              let d = self.getSFR('A*');
              let s = self.getByteUnit(s);
              //前7位
              if ((d.data + s.data) > 0x7f) {
                self.getSFR('PSW').OV = 1
              }
              d.data = d.data + s.data;
            }
          },
          ['SUBB'](d, s) {
            d = self.getSFR('A*');
            s = self.getByteUnit(s);
            //前7位
            if ((d.data - s.data) > 0x7f) {
              self.getSFR('PSW').OV = 1
            }
            d.data = parseInt(d.data) - self._getValueToInt(s);
          },
          ['MUL'](d, s) {},
          ['DIV'](d, s) {},
          ['INC'](d) {
            self.getByteUnit(d).data += 1;
          },
          ['DEC'](d) {
            self.getByteUnit(d).data -= 1;
          },
          ['DA'](d) {

          },
          ['CLR'](d) {
            self.getSFR('A*').data = 0;
          },
          ['CPL'](d) {
            self.getSFR('A*').data = ~self.getSFR('A').data;
          },
          ['RL'](d) {
            self.getSFR('A*').data = self.getSFR('A') << 7 ^ self.getSFR('A*').data >> 1
          },
          ['RR'](d) {
            self.getSFR('A*').data = self.getSFR('A') >> 7 ^ self.getSFR('A*').data << 1
          },
          ['RLC'](d) {},
          ['RRC'](d) {},
          ['SWAP'](d) { //sucess
            let A = self.getSFR('A*');
            let H4 = (0xF0 & parseInt(A.data, 16)) / 16;
            let L4 = 0x0F & parseInt(A.data, 16);
            self.getSFR('A*').data = L4 + '' + H4 + 'H';
          },
          ['ANL'](d, s) {},
          ['ORL'](d, s) {},
          ['XRL'](d, s) {},
          ['AJMP'](rel) {

            let id = self.lables.find(v => v.lable.replace(':', '') === rel).id;
            if (!id) {
              console.error('lable not fond')
            };
            self.goto(id);
          },
          ['LJMP'](rel) {
            let id = self.lables.find(v => v.lable.replace(':', '') === rel).id;
            if (!id) {
              console.error('lable not fond')
            };
            self.goto(id);
          },
          ['SJMP'](rel) {
            let id = self.lables.find(v => v.lable.replace(':', '') === rel).id;
            if (!id) {
              console.error('lable not fond')
            };
            self.goto(id);
          },
          ['JMP'](rel) { //间接转移指令
            let id = self.lables.find(v => v.lable.replace(':', '') === rel).id;
            if (!id) {
              console.error('lable not fond')
            };
            self.goto(id);
          },
          ['NOP'](d, s) {},
          ['JZ'](rel) {
            if (self.getSFR('A*').data == 1) {
              this.LJMP(rel);
            }
          },
          ['JNZ'](rel) {
            if (self.getSFR('A*').data == 0) {
              this.LJMP(rel);
            }
          },
          ['CJNE'](d, s, rel) {
            d = self._getValueToInt(self.getByteUnit(d));
            s = self._getValueToInt(self.getByteUnit(s))
            if (d === s) {
              return;
            } else if (d > s) {
              self.getSFR('PSW').CY = 0;
            } else if (d < s) {
              self.getSFR('PSW').CY = 1;
            }
            this.LJMP(rel);
          },
          ['DJNZ'](d, s, rel) {},
          ['ACALL'](d, s, rel) {},
          ['LCALL'](d, s, rel) {

          },
          ['RET'](d, s, rel) {},
          ['RETI'](d) {},
        }
      }

      _initRAML128() {
        //初始化工作寄存器(00H-1F)
        for (let i = 0; i < 4; i++) {
          this.workingRegistersGroup[i] = []
          for (let j = 0; j < 8; j++) {
            this.RAML128.push(new Register(i * 8 + j, 0))
            this.workingRegistersGroup[i][j] = new Register(i * 8 + j, 0x0, 'R' + j);
          }
        }

        for (let i = 0x20; i < 0x7F; i++) {
          this.RAML128.push(new ByteUnit(i, 0))
        }
      }

      /**
       * 初始化特殊功能寄存器
       **/
      _initSFR() {
        this.RAMH128.push(new SFR(0x80, 0, 'P0*')); //p0端口
        this.RAMH128.push(new SFR(0x81, 0, 'SP')); //堆栈指针
        this.RAMH128.push(new SFR(0x82, 0, 'DPL')); //数据指针L
        this.RAMH128.push(new SFR(0x83, 0, 'DPH')); //数据指针H
        this.RAMH128.push(new SFR(0x87, 0, 'PCON')); //电源控制
        this.RAMH128.push(new SFR(0x88, 0, 'TCON*')); //定时器控制
        this.RAMH128.push(new SFR(0x89, 0, 'TMOD')); //定时器模式
        this.RAMH128.push(new SFR(0x8A, 0, 'TL0')); //T0低字节
        this.RAMH128.push(new SFR(0x8B, 0, 'TL1')); //T1低字节
        this.RAMH128.push(new SFR(0x8C, 0, 'TH0')); //T0高字节
        this.RAMH128.push(new SFR(0x8D, 0, 'TH1')); //T1高字节
        this.RAMH128.push(new SFR(0x90, 0, 'P1*')); //p1端口
        this.RAMH128.push(new SFR(0x91, 0, 'SCON*')); //
        this.RAMH128.push(new PSW(0xD0, 0, 'PSW')); //程序状态字
        this.RAMH128.push(new SFR(0xE0, 0, 'A*')); //A累加器
        this.RAMH128.push(new SFR(0xF0, 0, 'B*')); //B寄存器
      }

      _initROMX() {
        for (let i = 0; i++; i < 0xFFFF) {
          this.RAMX.push(new ByteUnitX(i, 0));
        }
      }

      loadInstructs(code) {
        let ret = code.split(' ').map(i => i.split(','));
        let instructs = new Instructs(...getArray(ret));
        this.instructs.push(instructs);
        if (instructs.lable) {
          this.lables.push({
            id: instructs.id,
            lable: instructs.lable
          });
        }
      }


      /*
       * return [Number]or[ByteUnit]
       */
      getByteUnit(s) {
        const _getbyAddress = (address) => {
          if (/H/.test(address)) {
            address = address.replace('H', '')
          }
          address = address.toString(16);
          address = '0'.repeat(2 - address.length) + address;
          return this.RAML128.find(i => i.address === address)
        }
        const _getByRegisterName = (name) => {
          if (name === 'A') {
            return this.getSFR('A*');
          };
          if (name === 'B') {
            return this.getSFR('B*');
          };
          return this.workingRegistersGroup[this.RSG][parseInt(name.replace(/R/, ''), 16)]
        }
        if (/@[R,A,B]\+/.test(s)) { //变址寻址
        } else if (/^@[R,A,B]/.test(s)) { //寄存器间接寻址
          let register = _getByRegisterName(s.replace(/@/, ''));
          let ByteUnit = _getbyAddress(register.data + 'H');
          return ByteUnit;
        } else if (/^[R,A,B]/.test(s)) { //寄存器寻址
          let register = _getByRegisterName(s);
          return register;
        } else if (/^#[0-9a-fA-F]/.test(s)) { //立即数寻址
          return /H$/.test(s) ? parseInt(s.replace(/#/, ''), 16) : parseInt(s.replace(/#/, ''));
        } else if (/[0-9a-fA-F]/.test(s)) { //直接寻址
          let ByteUnit = _getbyAddress(s);
          return ByteUnit;
        } else {}
      }

      next() {
        if (this.PC === this.instructs.length) {
          return false;
        }
        return this.instructs[this.PC++];
      }

      goto(lable) {
        lable = parseInt(lable);
        if (typeof lable !== 'number') {
          return false;
        }
        if (lable <= 0 && lable >= this.instructs.length) {
          return false;
        }
        this.PC = lable;
      }

      print() {

        let workingRegistersGroup = [];
        let RAML128 = [];
        let RAMH128 = [];
        this.workingRegistersGroup[0].forEach(v => workingRegistersGroup.push({
          address: v.address,
          data: v.data,
          name: v.name
        }))

        this.RAML128.forEach(v => v.data != 0 ? RAML128.push({
          address: v.address,
          data: v.data
        }) : null)


        this.RAMH128.forEach(v => RAMH128.push({
          address: v.address,
          data: v.data,
          name: v.name
        }))

        if (RAML128,length>0) {
          console.table(RAML128);
        }
        console.log(this.getSFR('PSW'));
      }

      parse(instructs) {
        try {
          if (!instructs.oc) {
            return
          }
          log('PC->', this.PC - 1, 'd->', instructs.destination, 's->', instructs.source)
          this.OC[instructs.oc.toUpperCase()](instructs.destination, instructs.source, instructs.rel);
        } catch (e) {
          console.error(e);
        }
      }
    }


    function getArray(array) {
      let ret = [];
      (function get(array) {
        array.forEach(i => {
          if (i instanceof Array) {
            get(i);
          } else if (i !== '') {
            ret.push(i);
          }
        })
      })(array)
      return ret;
    }
  </script>


  <!-- 执行部分 -->
  <script>
    document
      .querySelector('textarea')
      .value = DEFAULT_CODE;

    /* 初始化历史记录器*/
    const history = new History();
    /* 初始化DOM */
    (() => {
      document.querySelectorAll('.list .item').forEach(element => {
        let name = element.querySelector('.name').innerHTML.replace(':', '');
        element.querySelector('.data').setAttribute('data-name', name);
      })
    })()
    /* 运行 */
    const run = () => {
      const program = new Program();
      Instructs.count = 0;
      document
        .querySelector('textarea')
        .value
        .split('\n')
        .forEach((code, index, self) => {
          program.loadInstructs(code);
        })
      const clock = setInterval(() => {
        let instructs = program.next();
        if (instructs) {
          let result = program.parse(instructs);
        } else {
          clearInterval(clock);
          program.print();
        }
      }, FREQUENC)
    }
  </script>
</body>

</html>
<!--
  格式：指令 目标 源


MOV R0,#32H
MOV A,#48H
MOV 32H,#80H
MOV 40H,08H

MOV A,@R0
MOV @R0,40H
MOV 40H,A
MOV R0,#35
-->